{% extends "base.html" %}
{% block page_header %}{% endblock %}
{% block content %}
    <!-- debug toggle (fixed, dashboard only) -->
    <button id="zcDebugToggle" type="button" title="Toggle debug" aria-label="Toggle debug"
      class="fixed top-3 right-3 z-50 px-2.5 py-2.5 rounded bg-slate-900/90 border border-slate-800 hover:bg-slate-800 text-slate-200 opacity-60 shadow">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
    </button>


<div class="bg-slate-900 rounded-xl p-4 border border-slate-800 mt-4">
  <div class="flex flex-col gap-3 border-b border-slate-800 pb-3">
    <div>
      <div class="text-xl font-bold">Anvil</div>
      <div class="text-xs text-slate-400">Zero Claw - Secure Task Manager Layer</div>
      <div class="text-xs text-slate-400 zc-debug hidden">Workflow: pending → approved/rejected → active → dev_done → review → done • {{ now }}</div>
    </div>

    <!-- all primary navigation lives here (centered) -->
    <div class="flex flex-wrap items-center justify-center gap-2">
      <a class="px-3 py-2 rounded bg-emerald-700 hover:bg-emerald-600 font-semibold" href="/tasks/new">+ New task</a>
      <a class="px-3 py-2 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700" href="/agents">Agents</a>
      <a class="px-3 py-2 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700" href="/routines">Routines</a>
      <a class="px-3 py-2 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700" href="/critiques">Critiques</a>
      <a class="px-3 py-2 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700" href="/logs">Logs</a>
    </div>
  </div>

  <!-- quick stats (kept above the board; no right sidebar) -->
  <div class="mt-3 flex flex-wrap justify-end gap-2 text-xs">
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Pending: <b>{{ tasks_by_status['pending']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Approved: <b>{{ tasks_by_status['approved']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Active: <b>{{ tasks_by_status['active']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Dev Done: <b>{{ tasks_by_status['dev_done']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Review: <b>{{ tasks_by_status['review']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Blocked: <b>{{ tasks_by_status['blocked']|length }}</b></div>
    <div class="rounded bg-slate-800 border border-slate-700 px-2 py-1">Done: <b>{{ tasks_by_status['done']|length }}</b></div>
  </div>

  <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 2xl:grid-cols-8 gap-3">
    {% for col in cols %}
      {% set label = col|capitalize %}
      {% if col == 'dev_done' %}{% set label = 'Dev Done' %}{% endif %}
      <div class="rounded-lg border border-slate-800 bg-slate-950/30 min-h-[62vh] min-w-0"
          data-col="{{ col }}"
          ondragover="event.preventDefault();"
          ondrop="dropCard(event);">
        <div class="px-3 py-2 border-b border-slate-800 flex items-center justify-between">
          <div class="font-semibold">{{ label }}</div>
          <div class="text-xs text-slate-400">{{ tasks_by_status[col]|length }}</div>
        </div>
        <div class="p-3 space-y-2">
          {% for t in tasks_by_status[col] %}
            <div class="rounded border border-slate-700 bg-slate-900 p-3 text-[13px] cursor-move overflow-hidden"
              draggable="true" ondragstart="dragCard(event);" data-task-id="{{ t['id'] }}">
              <div class="flex items-center justify-between gap-2">
                <a class="font-semibold hover:underline leading-snug break-words" href="/tasks/{{ t['id'] }}">{{ t['title'] }}</a>
                {% if t['status']=='pending' %}
                  <span class="text-[10px] px-2 py-0.5 rounded bg-amber-500/20 border border-amber-500/40 text-amber-200">needs approval</span>
                {% endif %}
              </div>
              <div class="mt-1 text-xs text-slate-300 break-words overflow-hidden" title="{{ t['description']|e }}"
                  style="display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;">{{ t['description'] }}</div>

              {% if t['review_summary'] %}
              <div class="mt-1.5 text-[11px] text-indigo-300 border-t border-slate-700/50 pt-1">
                <span class="font-semibold">Review:</span>
                <span class="text-slate-300" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">{{ t['review_summary'][:150] }}</span>
              </div>
              {% endif %}

              {% if t['status']=='pending' and t['requires_approval'] %}
                <div class="mt-2">
                  <button type="button" onclick="resendApproval({{ t['id'] }}); event.stopPropagation();"
                    class="text-[11px] px-2 py-1 rounded bg-slate-800 border border-slate-700 hover:bg-slate-700">Resend approval email</button>
                </div>
              {% endif %}
              <div class="mt-2 text-right">
                <span class="text-[10px] text-slate-500">{{ t['id'] }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    let draggedTaskId = null;
    function dragCard(ev){
      const el = ev.target.closest('[data-task-id]');
      draggedTaskId = el ? el.getAttribute('data-task-id') : null;
    }
    async function dropCard(ev){
      ev.preventDefault();
      const col = ev.currentTarget.getAttribute('data-col');
      if(!draggedTaskId) return;
      const res = await fetch('/api/tasks/move', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({task_id: parseInt(draggedTaskId), to_status: col})
      });
      const data = await res.json().catch(() => ({}));
      if(!data.ok){
        alert(JSON.stringify(data));
        return;
      }
      if(data.decision_view_url){
        window.location = data.decision_view_url;
        return;
      }
      window.location.reload();
    }

    async function resendApproval(taskId){
      try {
        const res = await fetch(`/tasks/${taskId}/complete`, {method: 'POST'});
        if(!res.ok){
          alert(await res.text());
          return;
        }
        alert('Approval email sent (or resent).');
      } catch(e){
        alert(String(e));
      }
    }
  
    // Auto-refresh every 15 seconds (pause during drag)
    let _dragging = false;
    const _origDragCard = dragCard;
    dragCard = function(ev){ _dragging = true; _origDragCard(ev); };
    const _origDropCard = dropCard;
    dropCard = async function(ev){ await _origDropCard(ev); _dragging = false; };
    setInterval(()=>{ if(!_dragging) window.location.reload(); }, 15000);
  </script>
</div>

{% endblock %}
